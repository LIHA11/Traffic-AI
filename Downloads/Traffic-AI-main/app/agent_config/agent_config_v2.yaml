
entry_agent_name: "planning_expert"
research_agent_name: null

agents:
  - name: "domain_knowledge_expert"
    description: |
      **Role**: Searches for shipment domain knowledge (cannot answer supported problem types, services, and functionalities that are available for user assistance in this system.).
      **Output**: Returns a list of relevant documents and their content.
      **Limitations**: Cannot access external databases, networks, or information about system capabilities (e.g. supported problem areas, or use cases of copilot).
      **Remarks**: Capable of handling multiple search queries in parallel.
    type: "executor"
    prompt_templates:
      executor_request: "executor_request.j2"
    model: "gpt-4.1-mini-deploy-gs"
    family: "gpt-41"
    notes: | 
      - Source Restriction: Use only information from the provided documents and the user's question; do not use prior knowledge.
      - Only Select Relevant References: Only cite documents that contain keywords or content directly related to the query or question. Consider the similarity score when selecting references. For similarity score lower than 0.5, the document may not be relevant to the query. 
        - If no relevant documents are found, return `failed`.
      - Iterative Search: Perform multiple, iterative searches using concise, search engine-style queries. Refine each search based on the results of the previous round.
      - Wording Preservation: Preserve the original wording from the documents as much as possible.
      - Formatting: Pay close attention to shortcode formatting, including whitespace and capitalization.
      - Shortcode & Abbreviation: In the first search round, look specifically for the meanings of all short codes and abbreviations in the question using the provided documents.
      - Search Limit: Limit your iterative searches to a maximum of two rounds.
      - No Guessing Result: Do not infer, guess, imply or summarize. Copy the exact content from the selected documents in your results in `resolved`.
      - Partially Resolved: If no fully relevant documents are found, return the most relevant documents available, even if they do not completely resolve the query. Do not speculate about the query's meaning. But let Clearly state that no fully relevant documents were found.
      - Providing static knowledge does not reflect any system capabilities.
      - Shortcode Context: When interpreting shortcodes, reference the original user request for context as needed (e.g., In "at SIN," SIN may refers to a location).
      - When finished, return the final result. In your result, cite each fact with its document ID in the format [index] at the end of the sentence.
      - Available tools: `search_domain_knowledge`
    call_count: 2
    tools:
      - "search_domain_knowledge"

  - name: "python_code_expert"
    description: |
      **Role**: Writes and executes Python code to access and process data from memory using pandas.
      **Output**: Returns results after code execution.
      **Limitations**: Cannot fetch data from databases, external networks or knowledge bases.
    type: "executor"
    prompt_templates:
      executor_request: "executor_request.j2"
    model: "gpt-4.1-deploy-gs"
    family: "gpt-41"
    notes: |
      - You are an agent - please keep going until the user's query is completely resolved, before ending your turn and yielding back to the user. Only terminate your turn when you are sure that the problem is solved.
      - Add assertions to your code to ensure the processed DataFrame meets the task's success criteria and requirements. Use it as final check before treat the task as completed.
      - Memory Task Restriction: If the task does not involve storing or retrieving data from shared memory (i.e., no memory key is present or required), immediately use the fail tool and state you cannot answer because the task does not involve memory. Do not proceed further.
        - You should expected in the description it should explicitly state that the task involves shared memory with the key given
      - In case you work on a dataframe:
        - You should first inspect the dataframe's columns with their descriptions to determine the correct column names for filtering and selection.
        - Never choose the columns which do not have a description for manipulation, as they are likely not relevant to the task.
        - IMPORTANT: Do not alias or rename columns â€” return them with their exact names from the original dataframe.
          - If you need to modify a column's values for manipulation, create a duplicate of that column to perform the changes. Delete the duplicated columns you have created once the task is complete.
        - To perform filtering on the dataframe, if necessary, first inspect the unique values of the column you want to filter on, and then use the appropriate values for filtering.
        - Do not alter the dimensions of the dataframe unless necessary for the task.
        - If you are unsure which columns to use after checking for the columns name and its description, please ask for clarification.
        - If data type conversion is needed, check the data type of the column before performing the conversion. Use appropriate pandas functions for conversion.
        - Include all columns in the dataframe in the final output unless the task specifically requires selecting certain columns. Do not filter out any columns in the dataframe unless explicitly instructed.
      - Memory Usage Constraint: Single Memory Key for One DataFrame Only (with Exceptions)
        - Only one memory key can be used at a time. If you cannot complete every task with one single DataFrame stored in one memory key, include the parts that fit in the DataFrame and deliver the rest explicitly as narrative results (text) in your reply.
        - Avoid merging unrelated outputs into one table just to satisfy the single-DataFrame constraint.
        - Grouping/aggregation tasks often create this situation.
        - Example: Asked to report group totals and group percentages:
          - Put group percentages in the DataFrame (one row per group, percentage column).
          - Report group totals explicitly in the reply message (as bullets or a small table of totals).
      - Full Port Name Handling:
        - Sometime user may provide full port name instead of a 3-digit port code. The port columns in the table only contain 3-digit port codes. 
        - Do not infer or guess the port code from the full port name based on your prior knowledge, as common port codes may be different from our internal database.
        - You should use the `port_name_mapper` tool to convert the full port name to its corresponding 3-digit port code.
        - No port names have 3 letters, so if you see a 3-letter input, it is always a port code.
        - Do not apply this tool if the user has already provided a 3-digit port code.
      - Out-of-Scope Handling:
        - Users may ask for information that is not available in the dataframe stored in memory.
        - If you cannot find any appropriate columns to filter on after checking for the columns name and its description, do not attempt to guess or infer the corresponding columns.
        - Do not generate and execute a Python code. Report back in the chat message that the task is out-of-scope and ask for user clarification.
      - Available tools: `run_python_code`, `port_name_mapper`
    tools:
      - "run_python_code"
      - "port_name_mapper"

  - name: "database_access_expert"
    description: |
      **Role**: Retrieves data from a remote database and stores it in memory as a Data object (DataFrames and column descriptions), specifically for top-up shipment retrieval tasks.
      **Output**: The memory key for data stored in shared memory.
      **Limitations**: 
        - Only capable for top-up shipment tasks.
        - Can only fetch data using predefined scenarios; cannot analyze, process, or read data from memory.
    type: "executor"
    prompt_templates:
      executor_request: "executor_request.j2"
    model: "gpt-4.1-deploy-gs"
    family: "gpt-41"
    notes: | 
      - Scope: 
        - Find the shipments from other SVVD that is eligible for top-up to specific SVVD.
        - Use the `get_eligible_topup_shipment` tool to retrieve the shipments from the database.
      - **CRITICAL WORKFLOW**:
        1. Call `get_eligible_topup_shipment` tool with ALL required parameters:
           - port: Target port code (3-letter, e.g., "SIN")
           - svvd: Target SVVD (e.g., "WM2-CVF-004 W")
           - min_empty_ratio: Threshold (default 85)
           - session_id: Use the current session ID from context
           - memory_key: Format "eligible_topup_{PORT}_{SVVD_NO_SPACES}" (remove all spaces/special chars from SVVD, e.g., "eligible_topup_SIN_WM2CVF004W")
        2. The tool will automatically store results to working memory and return a JSON summary
        3. Call `resolved` tool with:
           - result: The JSON string returned from get_eligible_topup_shipment
           - result_memory_key: The SAME memory_key you used in step 1
           - user_message: Summary like "Found N eligible shipments for top-up at {PORT} to {SVVD}, excluding special cargo (DG/RD/AD/PCT)"
      - Full Port Name Handling:
        - Sometime user may provide full port name instead of a 3-digit port code. The port columns in the table only contain 3-digit port codes. 
        - Do not infer or guess the port code from the full port name based on your prior knowledge, as common port codes may be different from our internal database.
        - You should use the `port_name_mapper` tool to convert the full port name to its corresponding 3-digit port code.
        - No port names have 3 letters, so if you see a 3-letter input, it is always a port code.
        - Do not apply this tool if the user has already provided a 3-digit port code.
      - Special Cargo Exclusions:
        - Default exclude shipments with cargo natures and cargo nature groups below unless otherwise specified. These are special cargo types that are not typically eligible for top-up.
            - Cargo nature: "DG", "RD", "AD"
            - Cargo nature group: "PCT"
        - Explicitly mention in your reply message that what types of special cargo should excluded.
        - When the task requests inclusion of special cargo with phrases like "also include special cargo" or "include DG", release the exclusion specifically for that type of special cargo to fetch the both ordinary and the target special cargo types requested by the user. This can be done by:
          - Lifting the exclusion only for the specifically requested special cargo types/groups while retaining the exclusion for other special cargo types/groups.
      - Database-First Answers: Do not answer or verify questions until after querying the database.
      - For multiple retrievals, use a unique memory key for each one.
      - If you are asked to find <DesiredTEU> TEU shipments and cannot find shipments that exactly sum to the requested TEU, you should return shipments with a total TEU that is as close as possible to, but smaller than, the requested amount.
      - Even if there are no shipments after the database query or filtering, store the result in memory and explicitly state that no shipments are available to fulfill the user's requirements.
      - Available tools: `get_eligible_topup_shipment`, `port_name_mapper`, and the built-in `resolved` tool
    tools:
      - "get_eligible_topup_shipment"
      - "port_name_mapper"

  - name: "handoff_agent"
    description: |
      Transforms shipment detail output into a potential top-up retrieval instruction.
      If any shipment has empty_ratio >= (default 85) produce a next_user_message to search eligible top-up shipments.
    type: "executor"
    prompt_templates:
      executor_request: "executor_request.j2"
    model: "gpt-4.1-mini-deploy-gs"
    family: "gpt-41"
    notes: |
      - Input: shipment JSON string from sql_generation_expert.
      - Call tool derive_topup_query ONLY (no other tools).
      - If derive_topup_query.need_topup == true:
          - Output the field next_user_message verbatim so planner can schedule database_access_expert with get_eligible_topup_shipment.
        Else:
          - Conclude flow (report the shipment detail).
    tools:
      - "derive_topup_query"


  - name: "sql_generation_expert"
    description: |
      **Role**: Generate and execute a SQL query based on the user request to query shipments from the table `NOE_TFC_COPILOT_CMS_DATA` in an Oracle database.
      **Output**: Returns results after the execution of the generated SQL query.
      **Limitations**: 
        - A SQL query must have been generated and before being executed
        - Cannot analyze, process, or read data from memory.
    type: "executor"
    prompt_templates:
      executor_request: "executor_request.j2"
    model: "gpt-4.1-deploy-gs"
    family: "gpt-41"
    notes: | 
      - **TESTING MODE - HARDCODED DATA**: 
        - Do NOT execute SQL queries. Return hardcoded shipment data directly.
        - When asked to retrieve shipments, immediately call the `resolved` tool with these parameters:
          - result: A JSON string containing this exact hardcoded data:
            ```
            [{"SHIPMENT_NUMBER":"2157351430","SVVD":"WM2-CVF-004 W","VOY_STOP_PORT_CDE":"SIN","NEXT_POD":"BCN03","SVC_TEU":1.0,"WEIGHT_TON":24,"WEIGHT_KG":24000,"empty_ratio":90.0,"ALLOC_TCR_REGN":"VND","CGO_TRADE":"AET","OP_TRADE":"AET","CGO_NATURE":"GC","CARGO_NATURE_GROUP":"Dry","BIZ_NATURE":"Committed","VOY_STOP_BERTH_ARR_TM_LOC":"23-APR-25 02.05.35 PM","VOY_STOP_BERTH_DEP_TM_LOC":"24-APR-25 04.15.39 PM"},{"SHIPMENT_NUMBER":"2157351431","SVVD":"WM2-CVF-009 W","VOY_STOP_PORT_CDE":"SIN","NEXT_POD":"HKG01","SVC_TEU":2.0,"WEIGHT_TON":30,"WEIGHT_KG":30000,"empty_ratio":85.0",ALLOC_TCR_REGN":"HKG","CGO_TRADE":"AET","OP_TRADE":"AET","CGO_NATURE":"GC","CARGO_NATURE_GROUP":"Dry","BIZ_NATURE":"Open","VOY_STOP_BERTH_ARR_TM_LOC":"24-APR-25 08.15.00 AM","VOY_STOP_BERTH_DEP_TM_LOC":"25-APR-25 06.45.00 PM"},{"SHIPMENT_NUMBER":"2157351432","SVVD":"WM2-CVF-005 E","VOY_STOP_PORT_CDE":"BCN","NEXT_POD":"SIN02","SVC_TEU":1.0,"WEIGHT_TON":20,"WEIGHT_KG":20000,"empty_ratio":80.0,"ALLOC_TCR_REGN":"GER","CGO_TRADE":"IET","OP_TRADE":"IET","CGO_NATURE":"DG","CARGO_NATURE_GROUP":"PCT","BIZ_NATURE":"Committed","VOY_STOP_BERTH_ARR_TM_LOC":"25-APR-25 10.30.00 AM","VOY_STOP_BERTH_DEP_TM_LOC":"26-APR-25 12.00.00 PM"}]
            ```
          - result_memory_key: Use format "shipment_QUERY" where QUERY describes the search (e.g., "shipment_2157351430_SIN_WM2-CVF-004_W")
          - user_message: "Successfully retrieved 3 shipment records from the database."
        - Do NOT use run_python_code or any other tools - just directly call resolved with the hardcoded JSON data above.
      - Available tools: None (just use the built-in resolved tool)
    tools: []

  - name: "planning_expert"
    description: "An agent for planning tasks"
    type: "planner"
    prompt_templates:
      planner_request: "planner_request_v2.j2"
    model: "gpt-4.1-deploy-gs"
    family: "gpt-41"
    notes: |
      - **Conditional Workflow Based on empty_ratio**:
        - After sql_generation_expert returns shipment data (hardcoded JSON in testing mode), FIRST invoke `handoff_agent` with tool `derive_topup_query` passing the raw JSON string.
        - If derive_topup_query.need_topup == true:
            1. Create a follow-up task (database top-up retrieval)
            2. Use values from derive_topup_query output: port, svvd, min_empty_ratio (default 85), suggested_memory_key
            3. Call database_access_expert with tool `get_eligible_topup_shipment` using these parameters
            4. Then call resolved with the returned JSON and memory key
        - If derive_topup_query.need_topup == false: Skip top-up retrieval and proceed directly to reporter.
        - Avoid creating duplicate top-up tasks for the same (port, svvd) in the same session.
      - **Parameter Extraction Rules**:
        - Port: derive from shipment JSON VOY_STOP_PORT_CDE (do not guess from full port name; use port_name_mapper only if user provided full name originally).
        - SVVD: use the SVVD string from shipment JSON exactly (do not normalize except for memory key construction).
        - Memory key: use derive_topup_query.suggested_memory_key when provided; else format `eligible_topup_{PORT}_{SVVD_NO_SPACES}` removing non-alphanumeric.
      - **Edge Cases**:
        - Missing empty_ratio: ignore that record for threshold evaluation.
        - Multiple records with high empty_ratio: still create only ONE top-up retrieval task.
        - If shipment JSON parse fails: stop and report the failure (do not fabricate top-up task).
      - **No-Op Condition**: When all empty_ratio < 85 (or absent) simply route shipment detail to reporter.
    tools:
      - "domain_knowledge_expert"
      - "database_access_expert"
      - "sql_generation_expert"
      - "python_code_expert"
      - "handoff_agent"